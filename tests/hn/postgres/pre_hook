#!/usr/bin/env bash

echo -e "Postgres (type $suffix):"

docker-compose -f ../../docker-compose.yml --env-file ../../.env stop postgres
docker-compose -f ../../docker-compose.yml --env-file ../../.env rm -f postgres

cmd="test=$test suffix=$suffix docker-compose -f ../../docker-compose.yml --env-file ../../.env up -d postgres"
echo -e "\tStarting postgres ($cmd)"
eval "$cmd"
while ! nc -z localhost 5432; do sleep 1; done
sleep 5
while ! nc -z localhost 5432; do sleep 1; done
sleep 5

if [[ $(docker exec postgres_engine psql -h0 -U postgres -c "select count(*) from $test;") ]]; then
  echo -e "\tNo need to rebuild"
  exit 10
fi
