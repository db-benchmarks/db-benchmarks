trap 'kill $(jobs -p)' EXIT

current_dir=$(basename "$PWD")
test_dir=$(realpath "$(dirname "$0")")
cd "$test_dir"

export test="$current_dir"

COLORED='\033[0;33m'
NC='\033[0m' # No Color

docker-compose -f ../../docker-compose.yml down
docker-compose -f ../../docker-compose.yml rm -fs

echo -e "${COLORED}Preparing CSV:${NC}"
./prepare_csv/prepare.sh | while IFS= read -r line; do echo -e "\t$line"; done
if [ $? -ne 0 ]; then
  echo -e "\tCouldn't prepare CSV"
  exit 1
fi

# Elasticsearch
. es/init

# Clickhouse
. ch/init

[ ! -n "$columnar_commit" ] && { echo "ERROR: No columnar_commit env. var. provided"; exit 2; }
[ ! -n "$daemon_commit" ] && { echo "ERROR: No daemon_commit env. var. provided"; exit 2; }

# Manticore Search
. manticore/init
