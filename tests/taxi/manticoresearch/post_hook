#!/usr/bin/env bash

echo -en "\tFinished loading to index at "
date

suffix=$suffix docker-compose -f ../../docker-compose.yml --env-file ../../.env restart manticoresearch

if timeout 60 grep -qm1 '\[BUDDY\] started' <(docker logs -f manticoresearch_engine); then
  echo 'Accepting connections';
else
  echo 'Manticore failed to start properly in 60 seconds';
  exit 1
fi

inserted=$(docker exec manticoresearch_engine mysql -h0 -P9306 -e "SELECT count(*) FROM $test\G" | grep count | cut -d" " -f2)
echo -e "\tCount of inserted documents: $inserted"

if [[ ! $inserted -eq 1732817071 ]]; then
  echo "Inserted count mismatch"
  exit 1
fi
