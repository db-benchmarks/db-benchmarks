#!/usr/bin/env bash

export ZINC_SEARCH_HOST='http://admin:dbbenchmarks@localhost:4080'

echo -e "Zincsearch (type $suffix):"
if [ "$(ls zincsearch/idx$suffix)" ]; then
  echo -e "${COLORED}\tNo need to rebuild${NC}"
  exit 10
fi

docker-compose -f ../../docker-compose.yml --env-file ../../.env stop zincsearch
docker-compose -f ../../docker-compose.yml --env-file ../../.env rm -f zincsearch
chmod -R 777 zincsearch/idx$suffix # otherwise zincsearch in docker won't start




cmd="test=$test suffix=$suffix docker-compose -f ../../docker-compose.yml --env-file ../../.env up -d zincsearch"
echo -e "\tStarting Zincsearch ($cmd)"
eval "$cmd"
echo -e "\tWaiting for Zincsearch to come up"

if timeout 60 grep -qm1 'Listen on :4080' <(docker logs -f zincsearch_engine 2>&1) >/dev/null; then
  echo -e '\tAccepting connections'
else
  echo -e '\tEngine failed to start properly in 60 seconds'
  exit 1
fi

curl "${ZINC_SEARCH_HOST}/es/_index_template" \
  -X POST \
  --data-binary @./zincsearch/template.json

if [ ! -f data/data.jsonl ]; then
  php ./quickwit/csv_jsonl.php ./data/data.csv ./data/data.jsonl
fi

if [ ! -f data/splitted_json.aaaaa ]; then
      awk '{ print "{ \"create\" : { \"_index\" : \"logs10m\" } }\n" $0 }' ./data/data.jsonl >./data/bulk.jsonl
      split -l 20000 -a 5 ./data/bulk.jsonl ./data/${test}_splitted.
      rm ./data/bulk.jsonl
fi
