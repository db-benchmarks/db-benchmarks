#!/usr/bin/env bash

cmd="test=$test suffix=$suffix docker-compose -f ../../docker-compose.yml --env-file ../../.env up -d quickwit"
echo -e "\tStarting Quickwit ($cmd)"
eval "$cmd"

if timeout 10 docker logs -f quickwit_engine | grep -qm1 'REST server is ready'; then
  echo -e "\tQuickwit ready to accept connections"
else
  echo -e "\tQuickwit timeout failed"
  exit 1
fi

export HOST='http://localhost:7280'

if [[ ! $(find ./quickwit/data/indexes/${test}/*.split > /dev/null 2>&1) ]]; then
  echo -e "\tStart building quickwit_engine"

  curl -s -XPOST "${HOST}/api/v1/indexes" \
    --header "content-type: application/yaml" \
    --data-binary @./quickwit/index-config.yaml >/dev/null

  if [ ! -f data/data.jsonl ]; then
    php ./quickwit/csv_jsonl.php ./data/data.csv ./data/data.jsonl
  fi

  split -l 10000 -a 5 ./data/data.jsonl ./data/data_splitted.

  echo -en "\tStarting loading at "
  date
  for f in ./data/data_splitted.*; do
    echo -e "\t\tUpload chunk $f"

      # Index our 10k documents.
    curl -s -XPOST "${HOST}/api/v1/${test}/ingest?commit=force" --data-binary @$f >/dev/null

    rm $f
  done
  echo -en "\tFinished loading to index at "
  date

  rm ./data/data.jsonl

  echo -e "\tFinished"
else

  echo -e "\tNo need to rebuild"
fi
